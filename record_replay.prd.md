# 模块 B — 录制与回放 PRD（独立版）

版本：v1.0（基于 tools_optimize.md 的提炼与优化）  
状态：Ready for Design  
负责人：产品（你/我），技术架构：前端架构（Calvin）

## 1. 背景与目标

- 目标：所见即所得录制用户在网页中的操作，并能稳定、可编辑、可参数化地回放；提供可观察性（日志/截图/网络片段）与管理能力（列表/搜索/导出/绑定）。
- 价值：
  - 降低重复网页操作的成本（登录、表单提交、批量处理）。
  - 为自动化测试与运营流程提供快速编排基础。
  - 与现有工具（chrome_read_page、chrome_computer、inject_script 等）无缝协同，减少新增复杂度。

## 2. 术语与范围

- 录制流（Flow）：由多个步骤（Step）组成的序列，描述一次完整操作。
- 步骤（Step）：原子操作（点击、输入、等待、滚动、导航、键盘、拖拽、断言、脚本节点）。
- 选择器候选（Selector Candidates）：用于定位元素的一组候选（id/data-testid/唯一 CSS/XPath/文本相似/ARIA）。
- 参数化：将步骤中的具体值替换为变量（如 {username}）。
- 运行记录（Run）：一次回放过程的结果与日志。
- 绑定（Binding）：将录制流关联到域/路径/URL，便于在对应页面快捷回放。

不在本期范围：

- 跨站点多域跳转（需后续安全策略评估）。
- 跨域 iframe 的深度操作（V1 不支持）。
- 可视化拖拽轨迹编辑器（V1 只记录与回放）。

## 3. 用户角色与关键场景

- 普通用户（运营/QA/开发）：创建并回放录制；编辑步骤、参数化输入；查看报错与截图。
- 管理者（高级用户）：批量管理录制；定时执行；导入导出；绑定页面快捷入口。

验收场景（在原始文档基础上明确成功标准）：

1. 基础录制与回放

- Given：普通登录场景（输入用户名/密码 -> 点击登录 -> 跳转 /dashboard）
- Then：回放 10 次成功率 ≥ 95%，单次耗时 ≤ 录制时长 1.5 倍，失败时提供截图 + 失败步骤高亮。

2. 选择器回退

- Given：页面改版首选选择器失效
- Then：自动回退到候选选择器并提示“选择器已回退，建议更新”，回放成功。

3. 网络波动重试

- Given：存在“等待导航完成”步骤
- Then：按配置自动重试（默认 3 次），最终失败输出“导航超时，已重试 3 次”并截图。

4. 绑定页面快捷回放

- Given：录制流绑定到 /login
- Then：打开 example.com/login 时，页面资源视图显示录制流，一键回放成功。

5. 参数化录制

- Given：步骤中输入使用 {username}/{password}
- Then：回放时提示输入参数，按参数执行并成功。

## 4. 完整用户流程（闭环）

### 4.1 开始录制

- 入口：
  - 插件 Popup 按钮“开始录制”；或从“录制流列表”页点击“新建录制”。
- 录制范围：当前页面（仅当前 Tab）/ 全局（允许导航/切换标签）。
- 可选开关：启用抓包（记录网络请求片段，仅用于调试显示，不回放）。
- 视觉反馈：页面显示红色角标“录制中”；高亮当前捕获的元素；提供暂停/停止悬浮控件。
- 捕获事件：click/dblclick、input/change、keydown/keyup（含快捷键）、scroll（页面/容器）、drag&drop、导航/刷新、标签页切换。
- 隐私防护：
  - 默认不存储密码/信用卡等敏感字段的明文；命中敏感字段类型时提示“记录为变量”并自动替换为变量。
  - 录制中可一键“隐藏输入值”（仅存变量占位符）。

### 4.2 编辑录制流

- 打开“流编辑器”（时间线 + 属性面板）。
- 时间线：展示步骤类型、目标元素（文本描述 + 元素缩略图）、耗时、是否带断言/等待。
- 属性面板可编辑：
  - 选择器候选及优先级（自动生成：id/data-testid/唯一 CSS/XPath/ARIA/文本相似）。
  - 等待条件：waitForSelector/waitForText/waitForNavigation/waitForNetworkIdle（可设超时）。
  - 滚动策略：scrollTo(element/offset/容器)。
  - 参数化：将常量替换为变量（可设置默认值、是否敏感）。
  - 脚本节点（自定义 JS）：执行前/后钩子（如“点击前清空输入框”）。
  - 断言：元素存在/可见、文本匹配、属性值校验。
- 保存：校验名称、描述、变量定义完整性；保存至本地存储并可导出 JSON。

### 4.3 回放

- 入口：录制流列表项上的“回放”，或页面资源视图中的快捷入口。
- 目标：当前标签页（可选刷新后回放）/ 新标签页。
- 时机：立即执行 / 定时（一次/重复）。
- 参数：回放前弹窗收集变量值（敏感值以密码输入，不落盘）。
- 实时日志：显示当前步骤、成功/失败/重试、失败截图、关键 Console 日志、（如开启）网络片段。
- 结束：展示报告（总耗时、成功/失败步骤、报错摘要），支持重试/跳至失败点回放/打开编辑器。

### 4.4 管理

- 列表：按名称/域名/标签搜索；筛选（域名/状态/最近使用）；排序（时间/名称）；批量删除/导出；克隆。
- 详情：基本信息、步骤数、平均耗时、绑定信息、最近 10 次运行记录。
- 绑定：支持绑定域/路径/URL；在“当前页面资源”区域显示入口。
- 导入导出：工作区导出包含所有录制流（JSON），支持单个导入与去重合并策略。

## 5. 功能需求清单（优化后的 FR）

录制（B-FR-001~003）：

- 支持事件集：click/dblclick/input/change/keydown/keyup（含组合键）/scroll/drag&drop/导航/刷新/标签页切换。
- 录制范围选择：当前页/全局；全局模式记录 Tab 创建/切换/URL 变化。
- 可选抓包：仅采集请求摘要（方法、URL、状态、时长、请求体大小、响应大小），不存储响应正文；仅用于报告展示。

编辑（B-FR-004~010）：

- 选择器多策略与优先级；自动回退（记录回退路径并提示修复）。
- 等待工具：waitForSelector/waitForText/waitForNavigation/waitForNetworkIdle；可配置超时/轮询间隔。
- 滚动工具：scrollTo(element/offset/container)。
- 参数化：变量定义（key、label、默认值、是否敏感、校验规则）。
- 脚本节点：before/after 钩子；失败不阻塞或阻塞可配。
- 断言：存在/可见/文本/属性；失败策略（失败即停/仅告警/重试）。

回放（B-FR-011~015）：

- 回放目标与时机；实时日志；失败自动截图与标注；失败重试（次数/间隔/指数退避）。
- 默认鲁棒性：
  - 每步自动“找元素 + 滚动到可见 + 可见性校验”。
  - 点击后自动判断是否发生导航（URL 变化或 beforeunload），智能附加 waitForNavigation。
  - 键入前确保 focus；IME 场景记录 composition 事件并重放。

管理与导出（B-FR-016~020）：

- 列表/详情/克隆/绑定/导出；导入时进行 Schema 版本检查与迁移。

### 5.1 借鉴 Automa 的增强能力（分期引入，默认 M2/M3）

- 可视化编排（V2/Beta）（B-FR-021）：除了时间线，还提供“节点画布 + 连线”的流程图编辑模式；支持子流程与从某节点开始调试；线性流自动显示为串联节点。
- 触发器（B-FR-022）：新增触发器类型，支持手动触发、页面匹配触发（域/路径/URL）、定时触发（Cron/扩展 alarms）、快捷键触发（commands），与绑定功能统一到“触发器”视图管理。
- 条件与循环（B-FR-023）：新增 If/Else、While/Until、ForEach（遍历数组/列表）等控制流节点；循环支持并发度配置与最大迭代保护，防止页面资源被占满。
- 多标签页编排（B-FR-024）：提供 OpenTab/SwitchTab/CloseTab/GotoURL 节点，支持在多标签间切换执行子流。
- 数据提取与数据集（B-FR-025）：新增“提取数据”节点（Selector/属性/文本/正则/自定义 JS），可写入“数据集（Dataset）”；提供数据集预览与导出 CSV/JSON；支持复制到剪贴板。
- HTTP 请求与脚本（B-FR-026）：“HTTP 请求”节点（GET/POST/...，可注入变量，响应截取保存至上下文）；“JS 代码”节点（MAIN/ISOLATED 选择，入参/出参可映射至上下文）。
- 变量与表达式（B-FR-027）：统一变量系统，支持 Mustache/模板表达式，允许从“节点输出”选择字段（提供 JSONPath/路径选择器），用于后续节点的输入映射；支持全局变量与环境变量。
- 错误处理（B-FR-028）：节点级“失败处理策略”（停止/继续/重试/跳转到错误分支）；画布支持 OnError 分支；失败截图与错误分类沿用回放日志能力。
- 并发与限流（B-FR-029）：ForEach/批处理节点支持并发度、重试与指数退避；全局并发上限与域级限流策略。
- 版本与导入导出（B-FR-030）：流程版本号与迁移策略；导入时支持与现有流合并/覆盖；导出包含节点、连接、变量定义与数据集 schema（不含敏感值）。
- 凭据与安全（B-FR-031）：HTTP 节点可引用“凭据”占位（仅内存使用/可选原生宿主加密存储）；默认不将敏感值写入本地存储与导出文件。

## 6. 非功能需求（NFR）

- 稳定性：典型业务页面 10 步内回放 ≥ 95% 成功率。
- 性能：录制开销不明显（CPU < 5% 波动）；回放单步默认等待不超过 10s；采集网络片段不显著拖慢页面。
- 安全：敏感数据默认变量化；不持久化敏感值；导出的 JSON 不含敏感值。
- 隐私合规：提示用户录制的内容仅用于本地；用户需对自身使用负责。
- 画布编辑（V2）：节点拖拽/连线在 500+ 节点仍保持流畅（60fps 优先级次之，保证操作不阻塞）。
- 并发执行（V3）：默认并发 ≤ 3；可配置上限 ≤ 10；内存与 CPU 占用监测不超过扩展可承受范围（给出警告与降级）。

## 7. 边界与降级策略

- DevTools 冲突：如无法抓包，降级为仅 UI 事件，并在 UI 显示“深度抓包不可用”。
- 跨域 iframe：V1 明确不支持，提示“请在父页面操作”。
- 复杂拖拽：记录离散轨迹（最多 N 点或按节流间隔），回放时按序列重放。
- 极长页面：优先 element 可见滚动；必要时按容器滚动。
- 页面变动造成选择器失效：自动回退 + 相似文本/ARIA 辅助匹配；仍失败则停在该步骤并截图。

## 8. 数据模型（对外导出 JSON 结构）

说明：变量需包含类型信息以支持生成 MCP 工具参数 Schema；可选配置输出暴露。

示例（带注释，实际文件不含注释）：

```jsonc
{
  "id": "flow_20251005_login",
  "name": "登录流程",
  "description": "示例站点登录",
  "version": 1,
  "meta": {
    "createdAt": "2025-10-05T10:00:00Z",
    "updatedAt": "2025-10-05T10:20:00Z",
    "domain": "example.com",
    "tags": ["login"],
    "bindings": [{ "type": "path", "value": "/login" }],
    "tool": { "category": "record_replay", "description": "自动登录" },
    "exposedOutputs": [{ "nodeId": "extract_profile", "as": "profile" }],
  },
  "variables": [
    { "key": "username", "label": "用户名", "type": "string", "sensitive": false, "default": "" },
    { "key": "password", "label": "密码", "type": "string", "sensitive": true },
    { "key": "rememberMe", "label": "记住我", "type": "boolean", "default": false },
  ],
  "steps": [
    {
      "type": "fill",
      "target": {
        "ref": "ref_12", // ephemeral; 优先尝试
        "candidates": [
          { "type": "css", "value": "#username" },
          { "type": "attr", "value": "[name=\"username\"]" },
          { "type": "aria", "value": "textbox[name=用户名]" },
        ],
      },
      "value": "{username}", // 参数化
      "wait": { "visible": true },
      "assert": null,
      "timeoutMs": 8000,
    },
    {
      "type": "fill",
      "target": { "ref": "ref_13", "candidates": [{ "type": "css", "value": "#password" }] },
      "value": "{password}",
      "wait": { "visible": true },
      "timeoutMs": 8000,
    },
    {
      "type": "click",
      "target": {
        "ref": "ref_14",
        "candidates": [
          { "type": "css", "value": "button[type=submit]" },
          { "type": "text", "value": "登录" },
        ],
      },
      "after": { "waitForNavigation": true, "timeoutMs": 15000 },
    },
    {
      "type": "assert",
      "assert": { "textPresent": "/dashboard" },
      "timeoutMs": 5000,
    },
  ],
}
```

## 10. MCP 工具集成（动态工具）

面向目标：将录制流“发布”为可被 MCP 客户端调用的工具（无需交互弹窗），与现有 chrome\_\* 工具并列显示。

### 10.1 发布与生命周期

- 发布入口：在流详情页/编辑器中点击“发布为工具”，填写/确认：
  - 工具名（可编辑，默认 `flow.<slug>`），描述、分类、标签；
  - 绑定限制（域/路径/URL，默认沿用 flow.meta.bindings）；
  - 版本策略：首次发布 v1；编辑后“更新为 v2”或“覆盖当前”。
- 状态：草稿/已发布/停用。支持取消发布（工具下线）。

### 10.2 输入 Schema（自动生成，可编辑）

- 以变量定义为基础生成 JSON Schema：
  - 类型映射：string/number/boolean/array/enum（enum 通过变量 rules.enum 推导）。
  - required：rules.required=true 的变量。
  - 默认值：variables.default。
  - 敏感：sensitive=true 的变量不落盘，调用时必须在 args 中提供；未提供即报错。
- 运行选项（内置可选字段）：
  - `tabTarget`: 'current'|'new'（默认 current）
  - `refresh`: boolean（默认 false）
  - `captureNetwork`: boolean（默认 false，仅摘要）
  - `returnLogs`: boolean（默认 false，返回精简日志）
  - `timeoutMs`: number（全局超时，可选）

### 10.3 输出规范（工具返回）

- 标准返回体：

```jsonc
{
  "runId": "run_...",
  "success": true,
  "summary": { "total": 8, "success": 8, "failed": 0, "tookMs": 5234 },
  "url": "https://example.com/dashboard",
  "outputs": {
    /* meta.exposedOutputs 或线性模式选定的关键结果 */
  },
  "logs": [{ "stepId": "...", "status": "success", "tookMs": 120 }],
  "screenshots": { "onFailure": null },
}
```

- V2（DAG）：可从 `meta.exposedOutputs` 挑选节点输出聚合；未配置则回传最后一步上下文快照的关键字段。

### 10.4 调用与安全

- 绑定校验：若当前页面域/路径不匹配绑定规则，则拒绝执行或要求显式允许导航。
- 导航策略：若提供 `startUrl`（可选），在新标签页打开并回放；否则使用当前标签页。
- 权限：敏感变量仅在调用参数中传入，不在任何持久化存储中出现。

### 10.5 冲突与命名规范

- 工具名命名：`flow.<slug>`，版本别名：`flow.<slug>@v<version>`；提供稳定别名 `flow.<slug>@latest`。
- 冲突处理：同名存在时需显式覆盖或修改名称；下线即从注册表移除。

### 10.6 发现与热更新

- 客户端工具列表中应显示动态工具（与 chrome\_\* 并列）；
- 流保存且“已发布”时触发热更新；取消发布时即时移除；版本升级时平滑替换 `@latest` 指向。

## 9. 成功指标（KPI）

- 使用效率：新用户在 3 分钟内完成首次录制与回放。
- 稳定性：基准用例（10 步）回放成功率 ≥ 95%。
- 可观测性：失败报告必含失败截图与错误原因；用户能在 1 分钟内定位问题。
- 可视化编排采纳率（V2）：创建的新流程中 ≥ 30% 使用画布模式编辑；
- 数据集导出：常见抓取类场景中，用户可 1 分钟内导出 CSV（≥ 80% 用户）。
- 工具化：发布为 MCP 工具后，十次调用成功率 ≥ 95%，参数缺失能被 Schema 友好提示。

## 11. 开放问题

- 是否需要团队级共享与协作（多人编辑/冲突解决）？
- 定时任务是否需要持久化跨浏览器重启？（依赖扩展 alarms + 重启恢复策略）
- 选择器“文本相似”策略的阈值与误命中成本如何权衡？

---

# 附：从 tools_optimize.md 明确摘取（并去重合并表述）

- 主流程：录制、编辑、回放、管理、页面资源视图快捷入口。
- FR：B-FR-001 ~ B-FR-020（详见第 5 节的优化版）。
- 边界：DevTools 冲突、跨域 iframe、复杂拖拽、极端长页面（详见第 7 节）。
